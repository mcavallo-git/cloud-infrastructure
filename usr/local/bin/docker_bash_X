#!/bin/bash
if [ -n "$0" ]; then
	
	if [ -z "$(which docker)" ]; then
		echo "Error: command \"docker\" not found";

	else

		test -v ARR_CONTAINER_IDS && unset ARR_CONTAINER_IDS; # Re-instantiate bash array via unset + declare
		test -v ARR_CONTAINER_IDS[@] && unset ARR_CONTAINER_IDS;
		declare -A ARR_CONTAINER_IDS;
		declare -A ARR_DOCKER_IMAGES;

		DOCKER_CONTAINER_IDS=$(docker ps --format "{{.ID}}");

		CHOICE_KEY=0;
		for EACH_CONTAINER_ID in ${DOCKER_CONTAINER_IDS[@]}; do
			CHOICE_KEY=$((CHOICE_KEY+1));
			EACH_DOCKER_IMAGE=$(docker ps --format "{{.Image}}" --filter "id=${EACH_CONTAINER_ID}");
			ARR_CONTAINER_IDS+=(["${CHOICE_KEY}"]="${EACH_CONTAINER_ID}");
			ARR_DOCKER_IMAGES+=(["${CHOICE_KEY}"]="${EACH_DOCKER_IMAGE}");
		done;

		if [ ${CHOICE_KEY} -le 0 ]; then
			echo "Error: No Containers found to be running - Please start a container then rerun \"${0}\"";
			
		else
			echo "";
			echo "Found the following dockers, locally:";
			echo "------------------------------------------------------------";
			for EACH_KEY in "${!ARR_CONTAINER_IDS[@]}"; do
				EACH_CONTAINER_ID="${ARR_CONTAINER_IDS[${EACH_KEY}]}";
				EACH_DOCKER_IMAGE="${ARR_DOCKER_IMAGES[${EACH_KEY}]}";
				echo "	${EACH_KEY}	-  ${EACH_DOCKER_IMAGE}  (${EACH_CONTAINER_ID})";
			done;
			echo "------------------------------------------------------------";
			echo "";

			MAX_READ_WAIT=20; read -p "Select which container to bash into:    " -t ${MAX_READ_WAIT} -r;
			if [ -n "${REPLY}" ]; then
				USER_SELECTION_KEY=$((0+"${REPLY}"));
				if [ -n "${ARR_CONTAINER_IDS[${USER_SELECTION_KEY}]}" ]; then
					E1="LINES=$(tput lines)";
					E2="COLUMNS=$(tput cols)";
					CONTAINER_ID="${ARR_CONTAINER_IDS[${USER_SELECTION_KEY}]}";
					DOCKER_IMAGE="${ARR_DOCKER_IMAGES[${USER_SELECTION_KEY}]}";
					echo "";
					echo "------------------------------------------------------------";
					echo "| Bashing into Docker Container";
					echo "|  |--> Container-ID: \"${CONTAINER_ID}\"";
					echo "|  |--> Image-Name:   \"${DOCKER_IMAGE}\"";
					echo "------------------------------------------------------------";
					echo "";
					# docker exec -e "${E1}" -e "${E2}" -it "${CONTAINER_ID}" script -q -c "/bin/bash" "/dev/null";
					docker exec -e "${E1}" -e "${E2}" -it "${CONTAINER_ID}" "/bin/bash";
				else
					echo "Error: Invalid Selection of \"${REPLY}\"";
				fi;
			else
				echo "";
				echo "Response timed out after ${MAX_READ_WAIT}s";
			fi;

		fi;

	fi;

else 
	echo "\n\n$ 0: Variable is either unset or contains a null value\n\n";
	exit 1;
	
fi;