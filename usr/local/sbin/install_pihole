#!/bin/bash
#
# LOCAL_SBIN="/usr/local/sbin/install_pihole" && echo "" > "${LOCAL_SBIN}" && vi "${LOCAL_SBIN}" && chmod 0755 "${LOCAL_SBIN}";
#
# ------------------------------------------------------------
if [ 0 -eq 1 ]; then  # RUN THIS SCRIPT

curl -H 'Cache-Control: no-cache' -s "https://raw.githubusercontent.com/mcavallo-git/cloud-infrastructure/master/usr/local/sbin/install_pihole?t=$(date +'%s.%N')" | bash;

fi;
# ------------------------------------------------------------
#
# Log all shell output & error output to logfile
#
LOGDIR="${HOME}/install_pihole_logs"; if [ -w "/var/log/" ]; then LOGDIR="/var/log/install_pihole"; fi;
mkdir -p "${LOGDIR}"; chown $(stat -c '%u:%g' $(dirname ${LOGDIR})) "${LOGDIR}"; chmod 0770 "${LOGDIR}";
LOGFILE="${LOGDIR}/$(basename ${LOGDIR})_$(date +'%Y%m%d_%H%M%S')"; echo -n "" > "${LOGFILE}"; chmod 0660 "${LOGFILE}";
exec > >(tee -a "${LOGFILE}" );
exec 2>&1;
#
# ------------------------------------------------------------
#
# Spin-up pihole instance (using docker-compose)
#
# ------------------------------------------------------------
#
# Free-up port 53 by stopping service [ systemd-resolved ] from listening on it
#  |
#  |--> Update "/etc/systemd/resolved.conf"
#  |     |--> Uncomment "DNS=" line and set to "DNS=8.8.4.4"
#  |     |--> Uncomment "FallbackDNS=" line and set to "FallbackDNS=1.1.1.1"
#  |     |--> Uncomment "DNSStubListener=" line and set to "DNSStubListener=no"
#  |
#  |--> Redirect "/etc/resolv.conf"
#  |     |--> Run [ ln -sf "/run/systemd/resolve/resolv.conf" "/etc/resolv.conf"; ]
#  |
#  |--> Restart the machine via [ reboot ]
#
# ------------------------------------------------------------
#
# Spin-up the pihole docker (after port 53 is freed up)
#
if [ 1 -eq 1 ]; then

  # Check to see if any pihole dockers are currently running (before updating/removing/replacing them with a newer version)
  DOCKER_NAME="pihole"; 
  FIRST_REINSTALL_CONFIRMATION="";
  SECOND_REINSTALL_CONFIRMATION="";
  RUNNING_PIHOLE_DOCKERS=$(docker ps --all --quiet --filter "name=${DOCKER_NAME}" | wc -l;);
  if [ ${RUNNING_PIHOLE_DOCKERS} -gt 0 ]; then
    # Require a first round of user confirmations ('Y' or 'y' keypress) before reinstalling pihole over an already-running instance of pihole
    echo -e "";
    echo -e " ! !        ! !";
    echo -e " ! ! NOTICE ! !  This will reinstall any existing ${DOCKER_NAME} dockers  ! ! NOTICE ! ! ";
    echo -e " ! !   |    ! !";
    echo -e "       |  ";
    read -p "       |--> Are you sure you want to continue?  (press 'y' to confirm)  " -a FIRST_REINSTALL_CONFIRMATION -n 1 -t 60 <'/dev/tty'; # Await single keypress
    echo -e "";
  fi;

  if [ ${RUNNING_PIHOLE_DOCKERS} -eq 0 ] || [[ "${FIRST_REINSTALL_CONFIRMATION}" =~ ^[Yy]$ ]]; then

    # Require a second round of user confirmations ('Y' or 'y' keypress) before reinstalling pihole over an already-running instance of pihole
    if [[ "${FIRST_REINSTALL_CONFIRMATION}" =~ ^[Yy]$ ]]; then
      echo -e "       |  ";
      read -p "       |--> Are you completely positive you want to continue?  (press 'y' to confirm)  " -a SECOND_REINSTALL_CONFIRMATION -n 1 -t 60 <'/dev/tty'; # Await single keypress
      echo -e "\n";
    fi;
    
    if [ ${RUNNING_PIHOLE_DOCKERS} -eq 0 ] || [[ "${SECOND_REINSTALL_CONFIRMATION}" =~ ^[Yy]$ ]]; then

      # ------------------------------
      # Ensure any volume-map directories exist
      CONFIG_DIR="/root/docker-configs/pihole";
      echo -e "\nCalling [ mkdir --parents --verbose \"${CONFIG_DIR}/etc/pihole/\" \"${CONFIG_DIR}/etc/dnsmasq.d/\"; ]...";
      mkdir --parents --verbose "${CONFIG_DIR}/etc/pihole/" "${CONFIG_DIR}/etc/dnsmasq.d/";  # Directories used for docker container volume maps

      # ------------------------------

      # Set the working directory
      echo -e "\nCalling [ cd \"${CONFIG_DIR}\"; ]...";
      cd "${CONFIG_DIR}";

      # ------------------------------

      # Download a base docker-compose YAML script (intended to be used for spinning up customized pihole containers)
      REMOTE_DOCKER_COMPOSE="https://raw.githubusercontent.com/mcavallo-git/cloud-infrastructure/master/var/lib/docker-compose/docker-compose.pihole.yml";
      COMPOSE_FILE="${CONFIG_DIR}/docker-compose.yml";
      echo -e "\nCalling [ curl -sL \"${REMOTE_DOCKER_COMPOSE}\" -o \"${COMPOSE_FILE}\"; chmod --verbose 0600 \"${COMPOSE_FILE}\"; ]...";
      curl -sL "${REMOTE_DOCKER_COMPOSE}" -o "${COMPOSE_FILE}";
      chmod --verbose 0600 "${COMPOSE_FILE}";

      # ------------------------------

      # If any pihole containers are already running locally
      REVERT_RESOLV_CONF=0;
      if [ ${RUNNING_PIHOLE_DOCKERS} -gt 0 ]; then
        if [ $(sed -rne 's/^# (nameserver 8.8.4.4)$/\0/p' '/etc/resolv.conf' | wc -l 2>'/dev/null';) -gt 0 ]; then
          # Add Google DNS to local DNS resolvers before removing current pihole container (and ruining loopback DNS resolution, if active)
          echo -e "\nTemporarily enabling DNS nameserver \"8.8.4.4\" in \"/etc/resolv.conf\"";
          sed -re 's/^# (nameserver 8.8.4.4)$/\1/' -i "/etc/resolv.conf";
          REVERT_RESOLV_CONF=1;
        fi;
        # Remove existing pihole dockers
        echo -e "\nCalling [ docker_sniper \"${DOCKER_NAME}\"; ]...";
        curl -H 'Cache-Control: no-cache' -s "https://raw.githubusercontent.com/mcavallo-git/cloud-infrastructure/master/usr/local/bin/docker_sniper?t=$(date +'%s.%N')" | bash -s -- "${DOCKER_NAME}";
        # docker_sniper "${DOCKER_NAME}";

        # Wait for local DNS resolution to recognize and update itself around the pihole DNS server going AWOL
        echo -e "\nSleeping for 30 seconds (to allow network resolution changes to propogate)...";
        sleep 30;
      fi;

      # ------------------------------
      # Spin up the pihole docker container
      echo -e "\nCalling [ cd \"${CONFIG_DIR}\"; docker-compose up --detach; ]...";
      cd "${CONFIG_DIR}";
      docker-compose up --detach;

      # Stop pihole & attempt to free-up port 53
      echo -e "\nCalling [ docker stop \"${DOCKER_NAME}\"; ]...";
      docker stop "${DOCKER_NAME}";

      # Free up port 53 for pihole --> Stop the 'systemd-resolved' service in order to free up port 53 (DNS) so that pihole may create a listening thread on port 53, effectively reserving the port for the pihole service, locally
      echo -e "\nCalling [ systemctl disable \"systemd-resolved.service\"; ]...";
      systemctl stop "systemd-resolved.service";
      echo -e "\nCalling [ systemctl stop \"systemd-resolved.service\"; ]...";
      systemctl disable "systemd-resolved.service";

      # Start pihole again once port 53 has been made available
      echo -e "\nCalling [ docker start \"${DOCKER_NAME}\"; ]...";
      docker start "${DOCKER_NAME}";

      # If we added a temporary DNS resolver's IP address (above) to /etc/resolv.conf, then now is the location in the script where it should be removed/cleaned-up (as it is only a workaround to download pihole's docker image while pihole itself doesn't exist to resolve DNS queries to find it)
      if [ ${REVERT_RESOLV_CONF} -eq 1 ]; then
        echo -e "\nDisabling DNS nameserver \"8.8.4.4\" from \"/etc/resolv.conf\"\n";
        sed -re 's/^(nameserver 8.8.4.4)$/# \1/' -i "/etc/resolv.conf";
      fi;

      if [ -z "$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)" ]; then
        # Pi-hole container does NOT exist
        echo -e "\nError:  Pi-hole docker not found";

      else
        # Pi-hole container DOES exist
        echo -e "\nInfo:  Pi-hole docker successfully created with container ID \"$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)\";";

        # ------------------------------
        #
        # Update pihole's adlists (which gravity pulls from)
        #
        FULLPATH_ADLISTS="/etc/pihole/adlists.list";
        echo -e "\nAdlists - Pulling in updated adlist entries from \"${FULLPATH_ADLISTS}\"...";
        # Search adlists for urls to pull from
        ADLISTS_ARR="$(docker exec "$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)" cat "${FULLPATH_ADLISTS}";)";
        ADLISTS_ARR_NO_DUPES=($(echo "${ADLISTS_ARR[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' ';));
        for EACH_ADLIST in "${ADLISTS_ARR_NO_DUPES[@]}"; do
          SQLITE_QUERY_SELECT="SELECT enabled FROM adlist WHERE address='${EACH_ADLIST}';";
          SQLITE_RESULT_SELECT="$(docker exec "$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)" sqlite3 /etc/pihole/gravity.db "${SQLITE_QUERY_SELECT}";)";
          SQLITE_QUERY_UPDATE="";
          if [[ -z "${SQLITE_RESULT_SELECT}" ]]; then
            # (Insert) Record doesn't (yet) exist for this adlist entry --> create it
            echo " |--> (Insert)  Adding/Enabling adlist entry:  '${EACH_ADLIST}' ...";
            SQLITE_QUERY_UPDATE="INSERT INTO adlist (address, enabled, comment) VALUES ('${EACH_ADLIST}',1,'Imported from ${FULLPATH_ADLISTS}');";
          elif [[ "${SQLITE_RESULT_SELECT}" -eq 0 ]]; then
            # (Update) Record exists for this adlist entry, but it is disabled --> enable it
            echo " |--> (Update)  Enabling adlist entry:  '${EACH_ADLIST}' ...";
            SQLITE_QUERY_UPDATE="UPDATE adlist ad SET ad.enabled=1 WHERE ad.address='${EACH_ADLIST}';";
          else
            # (Skipped) Record exists and is enabled, already
            echo " |--> (Skipped) Adlist entry already enabled:  '${EACH_ADLIST}' ...";
          fi;
          if [ -n "${SQLITE_QUERY_UPDATE}" ]; then
            echo "   |--> Calling [ docker exec \"$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)\" sqlite3 /etc/pihole/gravity.db \"${SQLITE_QUERY_UPDATE}\"; ]...";
            docker exec "$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)" sqlite3 /etc/pihole/gravity.db "${SQLITE_QUERY_UPDATE}";
          fi;
        done;

        # ------------------------------
        #
        # Update pihole's gravity (which pulls from its enabled adlists)
        #
        echo -e "\nSleeping for 15 seconds (to allow pihole container to boot up)...";
        sleep 15;
        echo -e "\nUpdating pihole's Gravity DB with latest adlist entries...";
        # echo " |--> Calling [ docker exec \"$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)\" pihole updateGravity; ]...";
        # docker exec "$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)" pihole updateGravity;
        echo " |--> Calling [ docker exec \"$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)\" pihole updateGravity && echo \${?}; ]...";
        docker exec "$(docker ps --all --quiet --filter "name=${DOCKER_NAME}";)" pihole updateGravity && echo ${?};

      fi;

    fi;

  fi;

fi;


#   !!!  PERFORM THE FOLLOWING STEPS MANUALLY (for the time being)  !!!
if [ 0 -eq 1 ]; then

  # Bash into the docker
  docker_bash_X;  # Download from [ https://raw.githubusercontent.com/mcavallo-git/cloud-infrastructure/master/usr/local/bin/docker_bash_X ]

  # 
  # Set pihole file permissions as-intended
  #
  chown -R "pihole:pihole" "/etc/pihole/";
  chown -R "pihole:pihole" "/etc/pihole/dhcp.leases";
  chown -R "pihole:pihole" "/etc/pihole/gravity.db";
  chown -R "pihole:pihole" "/etc/pihole/macvendor.db";
  chown -R "pihole:root"   "/etc/pihole/pihole-FTL.conf";
  chown -R "pihole:pihole" "/etc/pihole/pihole-FTL.db";

  #
  # Make sure pihole's "/etc/resolv.conf" contains line [ nameserver 127.0.0.1 ], to allow internal query-ing and adlist updating via [ pihole -g ]
  #  |--> via Docker Volume-Map to [ /etc/resolv.conf ] with read-only attribute ":ro" (to avoid it being updated/reverted)
  #

fi;


# ------------------------------------------------------------
#
# Citation(s)
#
#   discourse.pi-hole.net  |  "[Solved] While executing: attempt to write a readonly database error - Help / Community Help - Pi-hole Userspace"  |  https://discourse.pi-hole.net/t/solved-while-executing-attempt-to-write-a-readonly-database-error/33003/4
#
#   discourse.pi-hole.net  |  "Enabling HTTPS for your Pi-hole Web Interface - FAQs / Community How-to's - Pi-hole Userspace"  |  https://discourse.pi-hole.net/t/enabling-https-for-your-pi-hole-web-interface/5771
#
#   discourse.pi-hole.net  |  "How do I add list via cli - FAQs / Community How-to's - Pi-hole Userspace"  |  https://discourse.pi-hole.net/t/how-do-i-add-list-via-cli/43733/2
#
#   docs.pi-hole.net  |  "Overview of Pi-hole - Pi-hole documentation"  |  https://docs.pi-hole.net/
#
#   github.com  |  "GitHub - pi-hole/docker-pi-hole: Pi-hole in a docker container"  |  https://github.com/pi-hole/docker-pi-hole/
#
#   hub.docker.com  |  "pihole/pihole - Docker Hub"  |  https://hub.docker.com/r/pihole/pihole
#
#   www.linuxuprising.com  |  "Ubuntu: How To Free Up Port 53, Used By systemd-resolved - Linux Uprising Blog"  |  https://www.linuxuprising.com/2020/07/ubuntu-how-to-free-up-port-53-used-by.html
#
# ------------------------------------------------------------