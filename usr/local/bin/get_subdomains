#!/bin/bash
#
# LOCAL_BIN="/usr/local/bin/get_subdomains" && echo "" > "${LOCAL_BIN}" && vi "${LOCAL_BIN}" && chmod 0755 "${LOCAL_BIN}";
#
# ------------------------------------------------------------
#
# Log all shell output & error output to logfile
#
if [ -n "$2" ] && [[ "$2" == *"log"* ]]; then # log this script's output

LOGDIR="${HOME}/$(basename ${0})_logs"; if [ -w "/var/log/" ]; then LOGDIR="/var/log/$(basename ${0})"; fi;
mkdir -p "${LOGDIR}"; chown $(stat -c '%u:%g' $(dirname ${LOGDIR})) "${LOGDIR}"; chmod 0770 "${LOGDIR}";
LOGFILE="${LOGDIR}/$(basename ${LOGDIR})_$(date +'%Y%m%d_%H%M%S')"; echo "" > "${LOGFILE}"; chmod 0660 "${LOGFILE}";
exec > >(tee -a "${LOGFILE}" );
exec 2>&1;

fi;
#
# ------------------------------------------------------------

if [ -z "${1}" ]; then

	echo -e "\nError in call to \"get_subdomains\"\n  → Expected syntax:     >  get_subdomains HOSTNAME;\n";
	exit 1;

else

	shopt -s lastpipe; # If set, and job control is not active, the shell runs the last command of a pipeline not executed in the background in the current shell environment.
	          # |
	          # |--> e.g. extends scope of variables which get set/updated during "while ...; do" loop to be referenced AFTER said loop is "done;"
	          #           (normally, variables set during background tasks are scoped separately, and not able to be referenced afterwards)

	REGEX_IPV4='(((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))';
	SED_LINE='s/^(.+),'${REGEX_IPV4}'$/\0/p';
	SED_FQDN='s/^(.+),'${REGEX_IPV4}'$/\1/p';
	SED_IPV4='s/^(.+),'${REGEX_IPV4}'$/\2/p';

	SMOKE_TEST=$(curl -L -s "https://api.hackertarget.com/hostsearch/?q=${1}" | head -n 1;);
	if [ "${SMOKE_TEST}" == "error check your search parameter" ]; then
		echo -e "\nError in call to \"get_subdomains\"\n  →  Hostname not found:  \"${1}\"\n";
		exit 1;

	else

		# Re-instantiate bash array via unset + declare
		test -v ARR_IPV4_FQDN && unset ARR_IPV4_FQDN;
		test -v ARR_IPV4_FQDN[@] && unset ARR_IPV4_FQDN;
		declare -A ARR_IPV4_FQDN;

		# Resolved IPv4 addresses for given domain ( as ${1} )
		curl -L -s "https://api.hackertarget.com/hostsearch/?q=${1}" | sort | while read EACH_LINE; do
			EACH_FQDN=$(echo ${EACH_LINE} | cut -d, -f 1;);
			EACH_IPV4=$(echo ${EACH_LINE} | cut -d, -f 2;);
			test -v ARR_IPV4_FQDN["${EACH_IPV4}"] && ARR_IPV4_FQDN+=(["${EACH_IPV4}"]+=", ");
			ARR_IPV4_FQDN+=(["${EACH_IPV4}"]+="${EACH_FQDN}");
		done;

		ROLLBACK_IFS="${IFS}";
		IFS=$'\n'; # Set the global delimiter
		ARR_IPV4_FQDN_SORTED=($(sort <<<"${ARR_IPV4_FQDN[*]}"));
		IFS="${ROLLBACK_IFS}"; # Restore the global delimiter

		# Show all FQDNs (subdomain + domains), grouped by IPv4 address (tied to their DNS A-Record)
		# ARR_TABLE_ROWS=();
		for EACH_KEY in "${!ARR_IPV4_FQDN_SORTED[@]}"; do
			EACH_VAL="${ARR_IPV4_FQDN[${EACH_KEY}]}";
			EACH_KEY_RPAD="${EACH_KEY}$(printf %15s;)";
			EACH_KEY_RPAD="${EACH_KEY_RPAD:0:15}";
			echo "   ${EACH_KEY_RPAD} | ${EACH_VAL}";
			# ARR_TABLE_ROWS+=("   ${EACH_KEY_RPAD} | ${EACH_VAL}");
		done;

		# ROLLBACK_IFS="${IFS}";
		# IFS=$'\n'; # Set the global delimiter
		# ARR_TABLE_ROWS_SORTED=($(sort <<<"${ARR_TABLE_ROWS[*]}"));
		# IFS="${ROLLBACK_IFS}"; # Restore the global delimiter

		# echo "";
		# echo "   IPv4            | FQDN              ";
		# echo "  -----------------|-------------------";
		# for EACH_KEY in "${!ARR_IPV4_FQDN[@]}"; do
		#
		# done;

		exit 0;

	fi;

fi;

# ------------------------------------------------------------