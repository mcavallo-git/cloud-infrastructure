#!/bin/bash
# ------------------------------------------------------------
#
# Dynamically locate an open port on local device
#  |
#  |--> Note:  Ports 0 to 1023 are "Well-Known" Ports
#              Ports 1024 to 49151 are "Registered" Ports
#              Ports 49152 to 65535 are "Public" Ports
#
# ------------------------------------------------------------

if [ $(which NETSTAT.EXE 2>'/dev/null' | wc -l;) -gt 0 ]; then
# echo "Module not yet compatible on WSL (Windows Subsystem for Linux)";
IP_PORT_COLUMN=2;
NETSTAT_CLI="NETSTAT.EXE";
RESERVED_IP_PORTS="$(${NETSTAT_CLI} -nao | grep 'LISTEN' | grep ':' | grep -v 'processes' | awk "{print \$${IP_PORT_COLUMN}}";)";
else
IP_PORT_COLUMN=4;
NETSTAT_CLI="netstat";
RESERVED_IP_PORTS="$(${NETSTAT_CLI} -tulpen | grep 'LISTEN' | grep ':' | grep -v 'processes' | awk "{print \$${IP_PORT_COLUMN}}";)";
fi;

echo "${RESERVED_IP_PORTS}";

STARTING_PORT=40000;

if [ ! -v PORT_ITERATOR ]; then
  # PORT_ITERATOR=$(shuf -i 40000-42500 -n 1);  # Start on a random port in a given range
  PORT_ITERATOR=${STARTING_PORT};
else
  PORT_ITERATOR=$(expr ${PORT_ITERATOR} + 1);
fi;
DUPLICATE_PORT=1;
while [[ "${DUPLICATE_PORT}" != "0" ]]; do
  DUPLICATE_PORT=0;
  for EACH_IP_PORT in ${RESERVED_IP_PORTS}; do
    EACH_PORT="$(echo "${EACH_IP_PORT}" | rev | cut --delimiter=':' -f1 | rev )";
    if [[ "${EACH_PORT}" == "${PORT_ITERATOR}" ]]; then
      echo "  (Skipping - Port already reserved)     ${EACH_PORT}";
      DUPLICATE_PORT=1;
      PORT_ITERATOR=$(expr ${PORT_ITERATOR} + 1);
    fi;
  done;
done;

echo ${PORT_ITERATOR};

